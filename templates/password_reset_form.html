<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Password Reset</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/password_reset.css') }}">
</head>
<body>
<section>
    {% for _ in range(100) %}
    <span></span>
    {% endfor %}

    <div class="signin">
        <div class="content">
            <h2>Reset Your Password</h2>
            <div class="form">
                <form id="resetForm" method="POST" action="/pw_reset?u_id={{ u_id }}">
                    <div id="inputContainer">
                        <div class="inputBox">
                            <input type="password" id="newPassword" name="new_password" required>
                            <i>New Password</i>
                        </div>
                        <div class="password-strength-container">
                            <div id="passwordStrengthBar" class="password-strength-bar"></div>
                        </div>
                        <div class="inputBox">
                            <input type="submit" value="Reset Password">
                        </div>
                    </div>
                </form>
                <div class="error" id="errorMsg"></div>
                <div class="success" id="successMsg"></div>
                <div class="links">
                    <a href="/">Back to Login</a>
                </div>
            </div>
            <small class="fringe-labs-text">
                Made with love ❤️ by <a href="https://github.com/FringeLabs/" target="_blank">FringeLabs</a>
            </small>
        </div>
    </div>
</section>

<script>
const passwordInput = document.getElementById('newPassword');
const errorMsg = document.getElementById('errorMsg');
const successMsg = document.getElementById('successMsg');
const form = document.getElementById('resetForm');
const inputContainer = document.getElementById('inputContainer');
const strengthBar = document.getElementById('passwordStrengthBar'); 

function checkPasswordStrength(password) {
    let score = 0;
    if (!password) {
        return { score: 0, color: 'transparent' };
    }
    
    if (password.length >= 8) score += 20;
    if (password.length >= 12) score += 20;

    if (/[a-z]/.test(password)) score += 10; 
    if (/[A-Z]/.test(password)) score += 10; 
    if (/[0-9]/.test(password)) score += 15; 
    if (/[^A-Za-z0-9\s]/.test(password)) score += 15; 

    let barColor = 'transparent';

    if (score < 40) {
        barColor = 'red';
    } else if (score < 80) {
        barColor = 'orange';
    } else {
        barColor = 'lime'; 
    }

    
    score = Math.min(score, 100);

    return { score, color: barColor };
}

passwordInput.addEventListener('input', function() {
    const result = checkPasswordStrength(this.value);
    
    strengthBar.style.width = result.score + '%';
    strengthBar.style.backgroundColor = result.color;

    if (this.value.length === 0) {
         strengthBar.style.width = '0%';
         strengthBar.style.backgroundColor = 'transparent';
    }
});


form.addEventListener('submit', async function(event) {
    event.preventDefault();
    errorMsg.innerText = '';

    const password = passwordInput.value;
    if (password.length < 8) {
        errorMsg.innerText = '⚠️ Password must be at least 8 characters long.';
        passwordInput.focus();
        return;
    }

    const formData = new FormData(form);
    const response = await fetch(`/pw_reset?u_id={{ u_id }}`, {
        method: 'POST',
        body: formData
    });

    const result = await response.json();

    if (result.error) {
        errorMsg.innerText = result.error;
        successMsg.innerText = '';
    } else {
        errorMsg.innerText = '';
        successMsg.innerText = result.message || '✅ Password reset successfully!';
        inputContainer.style.display = 'none';
        strengthBar.style.display = 'none';
    }
});
</script>
</body>
</html>